<!DOCTYPE html>
<html lang="en">
	<head>
	<meta charset="UTF-8">
	<title>restore/Create task</title>
	<style>
* { outline: 1px solid red; }
th.row-header{text-align: left}
	</style>
	<script src="../public/utils.js"></script>
	<script src="../public/check_session_cookie.js"></script>
	<script src="make_form.js"></script>
	<script src="../public/serialize_form.js"></script>

<script>
let pending_types = fetch_data("/parameter_types");
let pending_params = fetch_data("/task_parameters");

window.onload = async function() {
	await redirect_if_not_logged_in(location, document);
	let get_param_types_result = await pending_types;
	let get_params_result = await pending_params;
	if(get_param_types_result.succeeded && get_params_result.succeeded)
	{
		let types = get_param_types_result.message;
		let params = get_params_result.message;
		generate_form(document, document.getElementById("paraminputs"), params, types)
	}
}

function submit_form(event, doc, subform)
{
	event.preventDefault();

	let output_object = {}
	output_object.name = doc.getElementById("task_name").value;
	output_object.parameters = {};
	serialize_form(subform, output_object.parameters);
	message = JSON.stringify(output_object);

	fetch("/tasks", {
		method: "POST",
		redirect: "error",
		headers: {
			"Accept": "application/json",
			"Content-Type": "application/json"
		},
		body: message
	}).then(function(response_message) {
		return response_message.json();
	}).then(function(response_object) {
		if(response_object.result === "successful")
		{ window.location.href = "mainpage.html"; }
		else
		{ window.alert(response_object.error_message); }
	});

	return false;
}
</script>

	</head>
	<body>
	<form onsubmit="return submit_form(event, document, paraminputs);">
		<h1>Create task</h1>
		<table>
			<tr>
				<th class="row-header">name</th>
				<td field-name="name" field-type-name="string" field-type-category="atom">
					<input id="task_name">
				</td>
			</tr>
		</table>

		<section id="paraminputs">
			<h1>Parameters</h1>
		</section>
		<nav id="formactions">
			<ul>
				<li><input type="button" value="Back to mainpage" onclick="location.href='mainpage.html'"></li>
				<li><input type="submit" value="Submit"></li>
			</ul>
		</nav>
	</form>
	</body>
</html>


